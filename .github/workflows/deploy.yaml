name: Deploy to Cloud Run

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Google Auth
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Create ServiceAccountKey.json
        run: |
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}' > ServiceAccountKey.json
      
      - name: Build and push Docker image
        run: |
          # Enable required APIs
          gcloud services enable cloudbuild.googleapis.com --project=industrial-management-sy-6b3fd
          
          # Create build logs bucket if it doesn't exist
          gcloud storage buckets describe gs://industry-management-system-build-logs --project=industrial-management-sy-6b3fd || \
          gcloud storage buckets create gs://industry-management-system-build-logs --location=asia-south2 --project=industrial-management-sy-6b3fd
          
          # Build and push image - using the dynamic github.sha
          gcloud builds submit --tag gcr.io/industrial-management-sy-6b3fd/industry-management-system:${{ github.sha }} \
            --project=industrial-management-sy-6b3fd
      
      - name: Deploy to Cloud Run
        run: |
          # Create the env-vars.yaml file
          cat > env-vars.yaml << EOF
          FIREBASE_API_KEY: '${{ secrets.FIREBASE_API_KEY }}'
          FIREBASE_AUTH_DOMAIN: '${{ secrets.FIREBASE_AUTH_DOMAIN }}'
          FIREBASE_PROJECT_ID: '${{ secrets.FIREBASE_PROJECT_ID }}'
          FIREBASE_STORAGE_BUCKET: '${{ secrets.FIREBASE_STORAGE_BUCKET }}'
          FIREBASE_MESSAGING_SENDER_ID: '${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}'
          FIREBASE_APP_ID: '${{ secrets.FIREBASE_APP_ID }}'
          EOF
    
          # Deploy to Cloud Run with the same image tag used in the build step
          gcloud run deploy industry-management-system \
            --image=gcr.io/industrial-management-sy-6b3fd/industry-management-system:${{ github.sha }} \
            --platform=managed \
            --region=asia-south2 \
            --port=5000 \
            --env-vars-file=env-vars.yaml \
            --allow-unauthenticated \
            --project=industrial-management-sy-6b3fd